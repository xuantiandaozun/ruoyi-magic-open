# AI 工作流工具统一返回格式设计文档

## 概述

为了规范化工具的返回结果，便于工作流准确判断工具执行状态，我们设计了一套统一的工具返回格式规范。所有工具都应该返回 JSON 格式的结果，包含 `success` 字段，当该字段为 `false` 时，工作流将自动停止执行。

## 核心数据结构

### ToolExecutionResult

所有工具都应该返回此格式的 JSON 字符串：

```json
{
  "success": true/false,              // 布尔值：true=成功，false=失败/空数据
  "operationType": "query/operation/save",  // 字符串：操作类型
  "data": {...},                      // 任意类型：实际数据内容
  "message": "操作说明或错误信息",    // 字符串：消息说明
  "metadata": {...}                   // 可选：额外的元数据
}
```

### 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `success` | Boolean | **关键字段**。true 表示操作成功且有数据，false 表示操作失败或无数据。工作流会检查此字段判断是否继续 |
| `operationType` | String | 操作类型：`query`（查询）、`operation`（操作）、`save`（保存） 等 |
| `data` | Object | 实际返回的数据内容，可以是任何类型（字符串、对象、数组等） |
| `message` | String | 操作说明或错误信息，用于告知 AI 操作结果 |
| `metadata` | Object | 可选的元数据，如分页信息、数据总数等 |

## 工具返回格式规范

### 1. 查询操作成功（有数据）

```java
// 使用便捷方法
return ToolExecutionResult.querySuccess(data, "成功查询用户列表");

// 生成的 JSON
{
  "success": true,
  "operationType": "query",
  "data": [...],
  "message": "成功查询用户列表"
}
```

### 2. 查询操作失败或无数据

```java
// 使用便捷方法
return ToolExecutionResult.empty("query", "未找到符合条件的数据");

// 生成的 JSON
{
  "success": false,
  "operationType": "query",
  "data": null,
  "message": "未找到符合条件的数据"
}
```

### 3. 保存操作成功

```java
// 使用便捷方法
return ToolExecutionResult.saveSuccess(saveResult, "博客文章保存成功");

// 生成的 JSON
{
  "success": true,
  "operationType": "save",
  "data": {...},
  "message": "博客文章保存成功"
}
```

### 4. 操作失败

```java
// 使用便捷方法
return ToolExecutionResult.failure("operation", "删除失败，权限不足");

// 生成的 JSON
{
  "success": false,
  "operationType": "operation",
  "data": null,
  "message": "删除失败，权限不足"
}
```

## 工具实现示例

### 示例 1：查询类工具（GitHub Trending）

```java
@Override
public String execute(Map<String, Object> parameters) {
    // ... 查询逻辑 ...
    
    List<GithubTrending> repositories = queryRepositories(...);
    
    if (repositories.isEmpty()) {
        // 无数据，返回失败
        return ToolExecutionResult.empty("query", "未找到符合条件的GitHub趋势仓库");
    }
    
    // 有数据，返回成功
    return ToolExecutionResult.querySuccess(formatRepositories(repositories), 
        "成功查询GitHub趋势仓库");
}
```

### 示例 2：保存类工具（Blog Save）

```java
@Override
public String execute(Map<String, Object> parameters) {
    String title = (String) parameters.get("title");
    String content = (String) parameters.get("content");
    
    // 参数验证
    if (StrUtil.isBlank(title)) {
        return ToolExecutionResult.failure("save", "博客标题不能为空");
    }
    
    // 执行保存
    Blog blog = new Blog();
    blog.setTitle(title);
    blog.setContent(content);
    
    boolean success = blogService.save(blog);
    
    if (success) {
        Map<String, Object> result = new HashMap<>();
        result.put("blogId", blog.getBlogId());
        result.put("title", blog.getTitle());
        return ToolExecutionResult.saveSuccess(result, "博客文章保存成功");
    } else {
        return ToolExecutionResult.failure("save", "博客文章保存失败");
    }
}
```

### 示例 3：查询类工具（Database Query）

```java
@Override
public String execute(Map<String, Object> parameters) {
    String sql = (String) parameters.get("sql");
    
    // 执行查询
    List<Row> rows = Db.selectListBySql(sql);
    
    if (rows.isEmpty()) {
        return ToolExecutionResult.empty("query", "数据库查询结果为空");
    }
    
    // 构建结果
    Map<String, Object> result = new HashMap<>();
    result.put("total", rows.size());
    result.put("data", rows);
    
    return ToolExecutionResult.querySuccess(result, "成功执行数据库查询");
}
```

## 工作流处理流程

### 工作流System Prompt增强

所有启用工具的步骤都会自动添加如下规则到 System Prompt：

```
【工具调用规则】
所有工具都会返回JSON格式的结果，包含以下结构：
{
  "success": true/false,   // true表示成功，false表示失败或空数据
  "operationType": "query/operation/save",  // 操作类型
  "data": {...},           // 实际数据内容
  "message": "..."         // 操作说明或错误信息
}

【重要规则】
1. 如果工具返回的success字段为false，说明操作失败或没有查询到数据
2. 当success为false时，请直接回复 "TOOL_EXECUTION_FAILED" (不包含引号)，不要尝试重新解释或生成其他内容
3. 这样做可以让系统知道数据获取失败，需要停止整个工作流
4. 只有当success为true时，才能使用返回的data数据继续你的任务
```

### 工作流停止逻辑

1. **LangChain4jAgentService 处理工具返回**：
   - 工具返回 JSON 格式结果
   - 若返回 null，转换为 `{"success":false,"operationType":"unknown","message":"工具返回null"}`
   - 将工具结果传给 AI

2. **AI 识别规则**：
   - AI 根据 System Prompt 识别 success=false 的情况
   - AI 直接回复 `TOOL_EXECUTION_FAILED`

3. **工作流引擎检查**：
   - 检测到 `TOOL_EXECUTION_FAILED` 标记
   - 抛出 ServiceException，停止工作流执行

```java
// AgenticWorkflowExecutionServiceImpl 中的检查逻辑
if ("TOOL_EXECUTION_FAILED".equals(agentResult)) {
    log.warn("步骤 {} 工具执行失败，停止工作流", step.getStepName());
    throw new ServiceException("工具执行失败或没有查询到数据，工作流已停止");
}
```

## 结果处理工具

### ToolResultProcessor

提供了便捷的工具结果处理方法：

| 方法 | 说明 |
|------|------|
| `isSuccess(resultJson)` | 判断结果是否成功 |
| `isEmpty(resultJson)` | 判断结果是否为空数据 |
| `extractData(resultJson)` | 提取结果中的 data 部分 |
| `parse(resultJson)` | 解析为 ToolExecutionResult 对象 |
| `getMessage(resultJson)` | 提取结果消息 |
| `toAiFriendlyMessage(resultJson)` | 生成 AI 可理解的消息 |

### 使用示例

```java
String toolResult = tool.execute(parameters);

// 检查是否成功
if (ToolResultProcessor.isSuccess(toolResult)) {
    Object data = ToolResultProcessor.extractData(toolResult);
    // 处理数据
} else if (ToolResultProcessor.isEmpty(toolResult)) {
    String msg = ToolResultProcessor.getMessage(toolResult);
    log.warn("工具返回空数据: {}", msg);
}
```

## 工具改造清单

已改造的工具：

- ✅ `GithubTrendingLangChain4jTool` - 查询 GitHub 趋势
- ✅ `DatabaseQueryLangChain4jTool` - 数据库查询
- ✅ `OssFileReadLangChain4jTool` - 读取 OSS 文件
- ✅ `BlogSaveLangChain4jTool` - 保存博客文章

待改造的工具：

- ⏳ `BlogEnSaveLangChain4jTool` - 保存英文博客
- ⏳ `SocialMediaArticleSaveLangChain4jTool` - 保存社交媒体文章
- ⏳ `AliImageGenerationLangChain4jTool` - 阿里图片生成
- ⏳ `GithubRepoTreeLangChain4jTool` - GitHub 仓库树形结构
- ⏳ `GithubFileContentLangChain4jTool` - GitHub 文件内容
- ⏳ `WorkflowManagementLangChain4jTool` - 工作流管理

## 优势

1. **统一规范**：所有工具采用统一的返回格式，便于管理和维护
2. **清晰的成功/失败区分**：通过 `success` 字段明确表示操作结果
3. **自动流程中断**：当工具执行失败时，工作流自动停止，避免错误数据传递
4. **灵活的操作类型**：支持查询、操作、保存等多种类型
5. **丰富的元数据支持**：可灵活添加额外的元数据信息
6. **易于调试**：通过 `message` 字段快速定位问题

## 注意事项

1. **必须实现 success 字段**：所有工具都必须在返回的 JSON 中包含 `success` 字段
2. **不要返回 null**：应该返回标准的 JSON 格式，而不是 null
3. **错误消息要清晰**：提供清晰的错误/空数据说明，帮助 AI 和用户理解问题
4. **避免混淆**：不要在 data 中混放成功和失败的不同数据结构，保持一致性
5. **测试流程中断**：确保当 success=false 时，工作流能够正确中断

