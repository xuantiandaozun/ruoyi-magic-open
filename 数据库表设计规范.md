# 数据库表设计规范

本文档基于代码生成器的优化经验，总结数据库表的设计规范，提高代码生成的准确性和智能化程度。

## 1. 表分类与继承策略

### 1.1 表类型分类

根据业务功能和使用场景，将表分为以下几类：

#### 业务主表
- **继承基类**：继承 `BaseEntity`，包含基础审计字段
- **软删支持**：添加 `del_flag` 字段支持软删除
- **完整功能**：包含完整的CRUD操作

#### 关联表（中间表）
- **不继承基类**：不继承 `BaseEntity`
- **无软删字段**：不需要软删除功能
- **简化结构**：只包含必要的外键字段

#### 配置表/字典表
- **视情况继承**：根据业务需求决定是否继承基类
- **软删可选**：根据数据重要性决定是否支持软删

### 1.3 继承控制标记

代码生成器支持通过表备注中的特殊标记来精确控制实体类的继承行为：

#### 标记语法
```sql
-- 表备注 [继承控制标记]
CREATE TABLE table_name (
    -- 字段定义
) COMMENT '表功能描述 [不继承]';
```

#### 支持的标记类型

##### 继承控制标记
- `[不继承]` - 实体类不继承任何基类，所有字段直接定义在实体类中
- `[继承]` - 实体类继承相应的基类（BaseEntity或TreeEntity），可省略，默认行为

#### 使用示例

```sql
-- 用户信息表（继承基类，默认行为）
CREATE TABLE sys_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    user_name VARCHAR(50) NOT NULL COMMENT '用户名',
    -- ... 其他字段
    create_by VARCHAR(64) COMMENT '创建者',
    create_time DATETIME COMMENT '创建时间'
) COMMENT '用户信息表';

-- 用户岗位关联表（不继承基类）
CREATE TABLE sys_user_post (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    user_id BIGINT COMMENT '用户ID',
    post_id BIGINT COMMENT '岗位ID'
) COMMENT '用户岗位关联表 [不继承]';

-- 强制继承基类（明确指定）
CREATE TABLE sys_config (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    config_key VARCHAR(100) NOT NULL COMMENT '配置键',
    config_value VARCHAR(500) COMMENT '配置值'
) COMMENT '系统配置表 [继承]';
```

#### 生成效果对比

**不继承基类（标记 `[不继承]`）**：
```java
@Data
@Table("sys_user_post")
public class SysUserPost {
    private Long id;
    private Long userId;
    private Long postId;
    // 所有字段直接定义在实体类中
}
```

**继承基类（标记 `[继承]` 或默认）**：
```java
@Data
@EqualsAndHashCode(callSuper = true)
@Table("sys_user")
public class SysUser extends BaseEntity {
    private Long id;
    private String userName;
    // createBy, createTime, updateBy, updateTime, remark 继承自 BaseEntity
}
```

#### 代码生成行为

**继承基类（默认或 `[继承]`）**：
- 生成完整的后端代码（Entity、Mapper、Service、Controller）
- 生成前端代码（Vue组件、API接口）
- 生成数据库同步SQL

**不继承基类（`[不继承]`）**：
- 只生成后端基础代码（Entity、Mapper、Service、Controller）
- 不生成前端代码（Vue组件）
- 不生成数据库同步SQL
- 适用于关联表、配置表等不需要完整CRUD功能的数据表

### 1.2 基类字段说明

`BaseEntity` 包含以下通用字段：

```java
/** 创建者 */
private String createBy;

/** 创建时间 */
private Date createTime;

/** 更新者 */
private String updateBy;

/** 更新时间 */
private Date updateTime;

/** 备注 */
private String remark;

```

#### 基类字段在数据库中的体现

```sql
-- 对应BaseEntity中的字段
create_by VARCHAR(64) COMMENT '创建者',
create_time DATETIME COMMENT '创建时间',
update_by VARCHAR(64) COMMENT '更新者',
update_time DATETIME COMMENT '更新时间',
remark VARCHAR(500) COMMENT '备注'
```

## 2. 软删字段规范

### 2.1 添加原则
- **业务主表必加**：重要的业务数据表必须支持软删除
- **关联表不加**：中间表不需要软删除功能
- **配置表可选**：根据数据重要性决定

### 2.2 字段定义
```sql
-- 软删字段（0代表存在 1代表删除）
del_flag TINYINT DEFAULT 0 COMMENT '删除标志（0代表存在 1代表删除）'
```

### 2.3 注解配置
```java
// 在实体类中使用MyBatis-Flex的软删注解
@Column(isLogicDelete = true)
private String delFlag;
```

## 3. 表命名规范

### 3.1 推荐的表命名格式

代码生成器支持以下表命名格式，按优先级顺序解析：

#### 格式一：三段式命名（推荐）
```
模块_业务_类型
```
**示例：**
- `sys_user_info` - 系统模块的用户信息表
- `biz_order_detail` - 业务模块的订单明细表
- `cms_article_content` - 内容管理模块的文章内容表

#### 格式二：两段式命名
```
模块_业务
```
**示例：**
- `sys_user` - 系统模块的用户表
- `biz_order` - 业务模块的订单表

#### 格式三：自定义前缀
```
前缀+业务名称
```
**示例：**
- `tb_user` - 使用 tb_ 前缀的用户表
- `t_order` - 使用 t_ 前缀的订单表

### 3.3 避免路径冲突规范

为了避免同模块下多个业务表生成的前端路径和权限菜单重合，表命名时需确保业务名称的唯一性：

#### 命名冲突示例
```
biz_qr_info（二维码信息表）+ biz_qr_generate_record（二维码生产记录表）
↓ 解析后
模块名：biz, 业务名：qr → 前端路径：qr, 权限：biz:qr:*
模块名：biz, 业务名：qr → 前端路径：qr, 权限：biz:qr:*
→ 路径和权限完全重合！
```

#### 推荐解决方案

**方案一：调整业务名称（推荐）**
```
biz_qr_info → biz_qr_code（二维码信息表）
biz_qr_generate_record → biz_qr_record（二维码生产记录表）
↓ 解析后
biz_qr_code: 模块名biz, 业务名qr-code → 路径:qr-code, 权限:biz:qr-code:*
biz_qr_record: 模块名biz, 业务名qr-record → 路径:qr-record, 权限:biz:qr-record:*
```

**方案二：使用三段式命名**
```
biz_qr_info_info（二维码信息表）
biz_qr_record_generate（二维码生产记录表）
↓ 解析后
biz_qr_info_info: 模块名biz, 业务名qr-info → 路径:qr-info, 权限:biz:qr-info:*
biz_qr_record_generate: 模块名biz, 业务名qr-record → 路径:qr-record, 权限:biz:qr-record:*
```

#### 设计原则
1. **业务名称唯一性**：同模块下各表的业务名称必须唯一
2. **语义清晰**：业务名称应准确反映业务含义
3. **长度适中**：避免过长的业务名称影响代码可读性
4. **一致性**：相同业务类型的表使用相似的命名模式

## 4. 字段设计规范

### 4.1 字段命名规范

1. **小写下划线**：字段名使用小写字母和下划线
2. **语义明确**：字段名应准确表达数据含义
3. **一致性**：相同含义的字段在不同表中保持一致

### 4.2 字段注释规范

字段注释支持特殊标记语法，可以精确控制代码生成行为：

#### 基本格式
```
字段含义 [标记1][标记2]
```

#### 支持的标记类型

##### 显示控制标记
- `[列表]` 或 `[显示]` - 强制在列表页面显示该字段
- `[不列表]` 或 `[不显示]` - 不在列表页面显示该字段

##### 查询控制标记
- `[查询]` - 将该字段设置为查询条件
- `[不查询]` - 不将该字段设置为查询条件

##### 必填控制标记
- `[必填]` - 设置为必填字段
- `[选填]` - 设置为选填字段

#### 注释示例

```sql
-- 用户表（业务主表：继承BaseEntity + 软删）
CREATE TABLE sys_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    user_name VARCHAR(50) NOT NULL COMMENT '用户名 [列表][查询][必填]',
    real_name VARCHAR(100) COMMENT '真实姓名 [列表]',
    email VARCHAR(100) COMMENT '邮箱地址 [查询]',
    phone VARCHAR(20) COMMENT '手机号码 [查询]',
    status TINYINT DEFAULT 1 COMMENT '状态（0正常 1停用） [列表][查询]',
    create_by VARCHAR(64) COMMENT '创建者',
    create_time DATETIME COMMENT '创建时间',
    update_by VARCHAR(64) COMMENT '更新者',
    update_time DATETIME COMMENT '更新时间',
    remark VARCHAR(500) COMMENT '备注 [不列表]',
    del_flag TINYINT DEFAULT 0 COMMENT '删除标志（0存在 1删除）'
);
```
```sql
-- 用户岗位关联表（关联表：不继承基类，无软删）
CREATE TABLE sys_user_post (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    user_id BIGINT COMMENT '用户ID',
    post_id BIGINT COMMENT '岗位ID'
);
```

#### 字典字段注释

对于使用字典的字段，可以通过注释自动创建字典：

```sql
-- 订单状态：0-待支付,1-已支付,2-已发货,3-已完成,4-已取消
order_status TINYINT COMMENT '订单状态（0待支付 1已支付 2已发货 3已完成 4已取消）',

-- 用户性别：0-女,1-男,2-未知
gender TINYINT COMMENT '性别（0女 1男 2未知）',
```

### 4.3 字段类型选择

#### 字符串类型
- `VARCHAR(50)` - 短文本（如用户名、编码等）
- `VARCHAR(100)` - 中等文本（如名称、标题等）
- `VARCHAR(500)` - 长文本（如描述、备注等）
- `TEXT` - 超长文本（如文章内容等）

#### 数值类型
- `TINYINT` - 状态字段（0/1状态）
- `INT` - 普通整数
- `BIGINT` - 大整数（主键、外键）
- `DECIMAL(10,2)` - 金额字段

#### 日期时间类型
- `DATETIME` - 完整日期时间
- `DATE` - 仅日期
- `TIME` - 仅时间

### 4.4 特殊字段规范

#### 主键字段规范
- **命名统一**：除关联表外，其他所有表的主键字段统一命名为 `id`
- **类型统一**：主键类型统一使用 `BIGINT`
- **自增配置**：推荐使用 `AUTO_INCREMENT` 自增

```sql
-- 业务主表主键
id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID'

-- 关联表主键（可使用复合主键或其他命名）
id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID'
```

#### 外键字段
```sql
user_id BIGINT COMMENT '用户ID',
dept_id BIGINT COMMENT '部门ID'
```

#### 状态字段
```sql
status TINYINT DEFAULT 1 COMMENT '状态（0正常 1停用）'
```

#### 时间戳字段
```sql
create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
```

#### 逻辑删除字段
```sql
del_flag TINYINT DEFAULT 0 COMMENT '删除标志（0存在 1删除）'
```

## 5. 索引设计规范

### 5.1 主键索引
- 每个表必须有主键
- 推荐使用自增 BIGINT 类型

### 5.2 唯一索引
```sql
-- 用户名唯一索引
UNIQUE KEY uk_user_name (user_name),

-- 业务唯一索引
UNIQUE KEY uk_biz_code (biz_code)
```

### 5.3 普通索引
```sql
-- 单列索引
KEY idx_user_id (user_id),

-- 复合索引
KEY idx_user_dept (user_id, dept_id),

-- 查询常用字段
KEY idx_create_time (create_time),
KEY idx_status (status)
```

## 6. 表注释规范

### 6.1 基本格式
```sql
-- 表功能描述 [继承控制标记]
CREATE TABLE table_name (
    -- 字段定义
) COMMENT '表功能描述 [继承控制标记]';
```

### 6.2 支持的标记类型

#### 继承控制标记
- `[不继承]` - 实体类不继承基类，所有字段直接定义；不生成前端代码和SQL，只生成后端基础代码
- `[继承]` - 实体类继承相应的基类，可省略，默认行为；生成完整的前后端代码和SQL

### 6.3 示例
```sql
-- 用户信息表（继承基类，默认行为）
CREATE TABLE sys_user (
    -- 字段定义
) COMMENT '用户信息表';

-- 用户岗位关联表（不继承基类）
CREATE TABLE sys_user_post (
    -- 字段定义
) COMMENT '用户岗位关联表 [不继承]';

-- 强制继承基类
CREATE TABLE sys_config (
    -- 字段定义
) COMMENT '系统配置表 [继承]';
```

## 7. 设计原则

### 7.1 规范化原则
1. **第一范式(1NF)**：确保每列原子性
2. **第二范式(2NF)**：消除部分依赖
3. **第三范式(3NF)**：消除传递依赖

### 7.2 性能原则
1. **适当冗余**：为提高查询性能，可适当冗余字段
2. **索引优化**：为常用查询字段建立索引
3. **字段长度**：根据实际需要设置合适长度

### 7.3 可维护性原则
1. **注释完整**：所有表和字段必须有清晰注释
2. **命名规范**：遵循统一的命名规范
3. **结构清晰**：表结构设计合理，便于理解

## 8. 代码生成配置

### 8.1 包名配置
在 `GenConstants.PACKAGE_NAME` 中配置基础包名：
```java
public static final String PACKAGE_NAME = "com.ruoyi.project.system";
```

### 8.2 表前缀配置
在 `GenConstants.TABLE_PREFIX` 中配置表前缀：
```java
public static final String TABLE_PREFIX = "sys_,biz_,cms_";
```

### 8.3 字段和表配置
- **字段配置**：通过字段注释标记控制字段生成行为
- **表配置**：通过表备注标记控制实体类继承行为，无需修改配置文件

## 9. 最佳实践

### 9.1 表设计检查清单
- [ ] 表名是否符合命名规范
- [ ] 主键字段是否为 `id BIGINT`（关联表除外）
- [ ] 是否有主键
- [ ] 业务名称是否在同模块下唯一（避免路径冲突）
- [ ] 字段类型是否合适
- [ ] 字段注释是否完整
- [ ] 是否有必要的索引
- [ ] 外键关系是否明确
- [ ] 表备注是否正确标记了继承控制（`[不继承]` 或 `[继承]`）

### 9.2 字段设计检查清单
- [ ] 字段名是否规范
- [ ] 是否设置了合适的默认值
- [ ] 字符串字段长度是否合理
- [ ] 数值字段范围是否合适
- [ ] 时间字段是否正确
- [ ] 是否标记了显示/查询属性

### 9.3 维护建议
1. **定期review**：定期检查表结构设计
2. **版本控制**：表结构变更要有记录
3. **文档同步**：及时更新设计文档
4. **测试验证**：修改后进行代码生成测试

---

**注意**：本规范基于代码生成器的优化经验制定，旨在提高代码生成的准确性和智能化程度。实际项目应根据具体业务需求适当调整。
